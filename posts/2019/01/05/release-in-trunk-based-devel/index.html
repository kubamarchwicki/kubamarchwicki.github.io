<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Releasing in trunk based development : Notepack</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="A randomized pack of notes">
    <link rel="canonical" href="http://jakub.marchwicki.pl/posts/2019/01/05/release-in-trunk-based-devel/">
    <link href="http://jakub.marchwicki.pl/feed.xml" rel="alternate" type="application/atom+xml" title="Notepack" />

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/foundation.css"/>
    <link rel="stylesheet" href="/css/coderay.css"/>
    <link rel="stylesheet" href="/css/asciidoctor.css"/>
    <script src="/js/vendor/modernizr.js"></script>    
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/foundicons/3.0.0/foundation-icons.min.css">

        
    <!-- google analytics async -->
    <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-439480-4']);
    _gaq.push(['_trackPageview']);
    (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
    </script>
    

</head>


    <body>

    <header class="site-header">

  <div class="wrap">

    <a class="site-title" href="/"><i class="fi-folder"></i>Notepack</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
           viewBox="0 0 18 15" enable-background="new 0 0 18 15" xml:space="preserve">
          <path fill="#505050" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0
            h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#505050" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484
            h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#505050" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0
            c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>
      <div class="trigger">      
        
          <a class="page-link" href="/posts/">All posts</a>
        
          <a class="page-link" href="/speaking/">All speaking</a>
        
          <a class="page-link" href="/consultancy/">Consultancy</a>
        
          <a class="page-link" href="/contact/">Contact</a>
        
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrap">
      <div class="post">

  <header class="post-header">
    <h1>Releasing in trunk based development</h1>
    <p class="meta">Jan 5, 2019</p>
  </header>

  <article class="post-content">
  <div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>I&#8217;ve been looking into <a href="https://trunkbaseddevelopment.com">trunk based development</a> recently. What I do in one of the projects fits the approach nicely (small team, frequent releases, some direct commits or short-lived branches, etc.).</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="problem">Problem</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The only struggle I have is tagging the releases. We do CI but not every coming goes to production, and we want to increment (change) the version once the code is shipped to the customer&#8217;s environment.</p>
</div>
<div class="paragraph">
<p>How in the trunk bases development (in an idiomatic way) should I do a release? How you feel with release commits on master? I can see two approaches (and the fact using Java + Maven bit that&#8217;s just tooling that should come in the way).</p>
</div>
<div class="olist arabic">
<div class="title">Approach #1</div>
<ol class="arabic">
<li>
<p>//version information in trunk: 'SNAPSHOT'</p>
</li>
<li>
<p><code>git checkout -b release/1.11</code></p>
</li>
<li>
<p>// update version on release branch and commit</p>
</li>
<li>
<p>// build the complete project and release</p>
</li>
<li>
<p><code>git checkout master</code></p>
</li>
<li>
<p>// continue with features</p>
</li>
</ol>
</div>
<div class="olist arabic">
<div class="title">Approach #2</div>
<ol class="arabic">
<li>
<p>// version information in trunk: '1.11-SNAPSHOT'</p>
</li>
<li>
<p><code>git branch release/1.11</code></p>
</li>
<li>
<p>// update version on the master branch to 1.12-SNAPSHOT'</p>
</li>
<li>
<p>git checkout release/1.11</p>
</li>
<li>
<p>// update version on release branch to '1.11' and commit</p>
</li>
<li>
<p>// build the complete project and release</p>
</li>
<li>
<p><code>git checkout master</code></p>
</li>
<li>
<p>// continue with features</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The second approach leaves a single commit in the repository&#8217;s history, which I&#8217;m not sure how to feel about. The latter approach makes the code slightly more traceable and the release process a bit easier.</p>
</div>
<div class="paragraph">
<p>Couldn&#8217;t decide so I ended up asking a <a href="https://stackoverflow.com/questions/54050444/release-version-commit-in-trunk-based-development/">stackoverflow question</a> and <a href="https://stackoverflow.com/a/54053085">got an answer pretty quickly</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="solution">Solution</h2>
<div class="sectionbody">
<div class="quoteblock">
<blockquote>
Instead of creating release branches just to update the versions, <strong>treat every commit as releasable in true CI/CD fashion</strong>
</blockquote>
<div class="attribution">
&#8212; danielorn<br>
<cite>https://stackoverflow.com/users/7146596/danielorn</cite>
</div>
</div>
<div class="paragraph">
<p>There is a fixed version in the source (say 'SNAPSHOT' or master), which is never edited by any developer. On every commit project is built, all tests run, and a releasable package is created.</p>
</div>
<div class="paragraph">
<p>The only outstanding issue is the unique, human-readable version numbers. I liked the solution suggested on stackoverfow</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Let the CI tool substitute the SNAPSHOT version to something like <code>&lt;git commit date&gt;-&lt;short git commit hash&gt;`</code>, which has the benefits of</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Being truly unique (thanks to the hash)</p>
</li>
<li>
<p>Being easily interpreted and compared by a human (thanks to the date)</p>
</li>
<li>
<p>Being reproducible (thanks to using git information)</p>
</li>
</ul>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>My thoughts were going a similar direction but not as straightforward as the one suggested by Daniel.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="implementation">Implementation</h2>
<div class="sectionbody">
<div class="paragraph">
<p>I&#8217;ve mentioned project is Java + Maven, so no surprise an XML built tool was used for experimentation. It also appears many Maven plugins can support <em>dynamic versioning</em>  of either a project of an artifact (or both). Plugins like <a href="https://github.com/jgitver/jgitver-maven-plugin">jgitver-maven-plugin</a> or <a href="https://github.com/git-commit-id/maven-git-commit-id-plugin">maven-git-commit-id-plugin</a> can be used. As <em>jgitver</em> requires running as a core extension, I&#8217;ve used the latter one for implementation.</p>
</div>
<div class="paragraph">
<p>My current build (snippet) work like this.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="preprocessor">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tag">&lt;project</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://maven.apache.org/POM/4.0.0</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">xmlns:xsi</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.w3.org/2001/XMLSchema-instance</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">xsi:schemaLocation</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>

    <span class="tag">&lt;groupId&gt;</span>mygroup<span class="tag">&lt;/groupId&gt;</span>
    <span class="tag">&lt;artifactId&gt;</span>myproject<span class="tag">&lt;/artifactId&gt;</span>
    <span class="tag">&lt;version&gt;</span>LATEST<span class="tag">&lt;/version&gt;</span> <b class="conum">(1)</b>
    <span class="tag">&lt;packaging&gt;</span>jar<span class="tag">&lt;/packaging&gt;</span>

    <span class="tag">&lt;properties&gt;</span>
        <span class="tag">&lt;maven.build.timestamp.format&gt;</span>
            yyyyMMdd <b class="conum">(2)</b>
        <span class="tag">&lt;/maven.build.timestamp.format&gt;</span>
    <span class="tag">&lt;/properties&gt;</span>

    <span class="tag">&lt;profiles&gt;</span>
        <span class="tag">&lt;profile&gt;</span>
            <span class="tag">&lt;id&gt;</span>git_revision_in_finalName<span class="tag">&lt;/id&gt;</span>
            <span class="tag">&lt;activation&gt;</span>
                <span class="tag">&lt;file&gt;</span>
                    <span class="tag">&lt;exists&gt;</span>.git<span class="tag">&lt;/exists&gt;</span> <b class="conum">(3)</b>
                <span class="tag">&lt;/file&gt;</span>
            <span class="tag">&lt;/activation&gt;</span>
            <span class="tag">&lt;build&gt;</span>
                <span class="tag">&lt;finalName&gt;</span>
                    ${project.name}-${maven.build.timestamp}_${git.commit.id.abbrev}
                <span class="tag">&lt;/finalName&gt;</span> <b class="conum">(4)</b>
            <span class="tag">&lt;/build&gt;</span>
        <span class="tag">&lt;/profile&gt;</span>
    <span class="tag">&lt;/profiles&gt;</span>


    <span class="tag">&lt;build&gt;</span>
        <span class="tag">&lt;finalName&gt;</span>${project.name}-${project.version}<span class="tag">&lt;/finalName&gt;</span>
        <span class="tag">&lt;plugins&gt;</span>
            <span class="tag">&lt;plugin&gt;</span>
                <span class="tag">&lt;groupId&gt;</span>pl.project13.maven<span class="tag">&lt;/groupId&gt;</span>
                <span class="tag">&lt;artifactId&gt;</span>git-commit-id-plugin<span class="tag">&lt;/artifactId&gt;</span>
                <span class="tag">&lt;version&gt;</span>2.2.6<span class="tag">&lt;/version&gt;</span>
                <span class="tag">&lt;executions&gt;</span>
                    <span class="tag">&lt;execution&gt;</span>
                        <span class="tag">&lt;id&gt;</span>get-the-git-infos<span class="tag">&lt;/id&gt;</span>
                        <span class="tag">&lt;goals&gt;</span>
                            <span class="tag">&lt;goal&gt;</span>revision<span class="tag">&lt;/goal&gt;</span>
                        <span class="tag">&lt;/goals&gt;</span>
                    <span class="tag">&lt;/execution&gt;</span>
                <span class="tag">&lt;/executions&gt;</span>
                <span class="tag">&lt;configuration&gt;</span>
                    <span class="tag">&lt;failOnNoGitDirectory&gt;</span>false<span class="tag">&lt;/failOnNoGitDirectory&gt;</span> <b class="conum">(5)</b>
                <span class="tag">&lt;/configuration&gt;</span>
            <span class="tag">&lt;/plugin&gt;</span>
        <span class="tag">&lt;/plugins&gt;</span>
    <span class="tag">&lt;/build&gt;</span>
<span class="tag">&lt;/project&gt;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The default project version is <strong>LATEST</strong></p>
</li>
<li>
<p>I format the Maven appropriately, to use in the <em>finalName</em></p>
</li>
<li>
<p>When git repository is present use the date and commit id in the file name, otherwise use the default final Name</p>
</li>
<li>
<p>The resulting name is <strong>myproject-20190105-e82886d.jar</strong></p>
</li>
<li>
<p>If there is no git folder, the plugin execution is skipped.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>I&#8217;m happy with this approach. However, I fiddled a bit with a different approach: create a release branch, to keep the release code on a separate branch (to be able to deploy an existing version with hotfixes) and use more semantic versioning <em>(semver)</em> approach.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="preprocessor">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tag">&lt;project&gt;</span>

    <span class="tag">&lt;groupId&gt;</span>mygroup<span class="tag">&lt;/groupId&gt;</span>
    <span class="tag">&lt;artifactId&gt;</span>myproject<span class="tag">&lt;/artifactId&gt;</span>
    <span class="tag">&lt;version&gt;</span>master<span class="tag">&lt;/version&gt;</span> <b class="conum">(1)</b>
    <span class="tag">&lt;packaging&gt;</span>jar<span class="tag">&lt;/packaging&gt;</span>

    <span class="tag">&lt;profiles&gt;</span>
        <span class="tag">&lt;profile&gt;</span>
            <span class="tag">&lt;id&gt;</span>git_revision_in_finalName<span class="tag">&lt;/id&gt;</span>
            <span class="tag">&lt;activation&gt;</span>
                <span class="tag">&lt;file&gt;</span>
                    <span class="tag">&lt;exists&gt;</span>.git<span class="tag">&lt;/exists&gt;</span>
                <span class="tag">&lt;/file&gt;</span>
            <span class="tag">&lt;/activation&gt;</span>
            <span class="tag">&lt;build&gt;</span>
                <span class="tag">&lt;finalName&gt;</span>
                    ${project.name}-${git.branch.release}
                <span class="tag">&lt;/finalName&gt;</span> <b class="conum">(2)</b>
            <span class="tag">&lt;/build&gt;</span>
        <span class="tag">&lt;/profile&gt;</span>
    <span class="tag">&lt;/profiles&gt;</span>


    <span class="tag">&lt;build&gt;</span>
        <span class="tag">&lt;finalName&gt;</span>${project.name}-${project.version}<span class="tag">&lt;/finalName&gt;</span>
        <span class="tag">&lt;plugins&gt;</span>
            <span class="tag">&lt;plugin&gt;</span>
                <span class="tag">&lt;groupId&gt;</span>pl.project13.maven<span class="tag">&lt;/groupId&gt;</span>
                <span class="tag">&lt;artifactId&gt;</span>git-commit-id-plugin<span class="tag">&lt;/artifactId&gt;</span>
                <span class="tag">&lt;version&gt;</span>2.2.6<span class="tag">&lt;/version&gt;</span>
                <span class="tag">&lt;executions&gt;</span>
                    <span class="tag">&lt;execution&gt;</span>
                        <span class="tag">&lt;id&gt;</span>get-the-git-infos<span class="tag">&lt;/id&gt;</span>
                        <span class="tag">&lt;goals&gt;</span>
                            <span class="tag">&lt;goal&gt;</span>revision<span class="tag">&lt;/goal&gt;</span>
                        <span class="tag">&lt;/goals&gt;</span>
                    <span class="tag">&lt;/execution&gt;</span>
                <span class="tag">&lt;/executions&gt;</span>
                <span class="tag">&lt;configuration&gt;</span>
                    <span class="tag">&lt;failOnNoGitDirectory&gt;</span>false<span class="tag">&lt;/failOnNoGitDirectory&gt;</span>
                    <span class="tag">&lt;replacementProperties&gt;</span>
                        <span class="tag">&lt;replacementProperty&gt;</span>
                            <span class="tag">&lt;property&gt;</span>git.branch<span class="tag">&lt;/property&gt;</span>
                            <span class="tag">&lt;propertyOutputSuffix&gt;</span>release<span class="tag">&lt;/propertyOutputSuffix&gt;</span>
                            <span class="tag">&lt;token&gt;</span>^([^\/]*)\/([^\/]*)$<span class="tag">&lt;/token&gt;</span>
                            <span class="tag">&lt;value&gt;</span>$2<span class="tag">&lt;/value&gt;</span>
                            <span class="tag">&lt;regex&gt;</span>true<span class="tag">&lt;/regex&gt;</span>
                        <span class="tag">&lt;/replacementProperty&gt;</span>
                    <span class="tag">&lt;/replacementProperties&gt;</span>

                <span class="tag">&lt;/configuration&gt;</span>
            <span class="tag">&lt;/plugin&gt;</span>
        <span class="tag">&lt;/plugins&gt;</span>
    <span class="tag">&lt;/build&gt;</span>
<span class="tag">&lt;/project&gt;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The default project version is <strong>master</strong> to keep it consistent with git-based naming (no matter if <em>.git</em> folder is present or not)</p>
</li>
<li>
<p>The final name is based on the git branch name (either master or release number);  <strong>myproject-1.3.jar</strong> when built from branch <code>release/1.3</code></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The latter approach works as well and produces a version as expected. However, I consider this much more fragile (more corner cases with different branch names), and I&#8217;ve stuck to the initial approach.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="conclusions">Conclusions</h2>
<div class="sectionbody">
<div class="paragraph">
<p>From now on, all the commits are potentially releasable and which artifact gets released is a subject of preference. Whichever goes to production, is traceable in a human-readable way.</p>
</div>
</div>
</div>
  </article>

  
	<div id="disqus_thread"></div>
	<script type="text/javascript">
	    /* * * CONFIGURATION VARIABLES * * */
	    var disqus_shortname = 'jakubblog';
	    

	    /* * * DON'T EDIT BELOW THIS LINE * * */
	    (function() {
	        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
	        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
	        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	    })();
	</script>
	<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>

  
</div>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrap">

    <div class="column">
      <ul  style="margin-bottom: 0 !important">
        
          
          <li><a href="/posts/">
            <span class="icon foundation-icon"><i class="fi-page-multiple"></i></span>
            <span class="username">All posts</span>
            </a>
          </li>
          
        
          
          <li><a href="/speaking/">
            <span class="icon foundation-icon"><i class="fi-microphone"></i></span>
            <span class="username">All speaking</span>
            </a>
          </li>
          
        
          
          <li><a href="/consultancy/">
            <span class="icon foundation-icon"><i class="fi-comments"></i></span>
            <span class="username">Consultancy</span>
            </a>
          </li>
          
        
          
          <li><a href="/contact/">
            <span class="icon foundation-icon"><i class="fi-address-book"></i></span>
            <span class="username">Contact</span>
            </a>
          </li>
          
        
      </ul>
      <ul>
        <li>
          <a href="https://github.com/kubamarchwicki">
            <span class="icon foundation-icon"><i class="fi-social-github"></i></span>
            <span class="username">kubamarchwicki</span>
          </a>
        </li>
        <li>
          <a href="https://twitter.com/kubem">
            <span class="icon foundation-icon"><i class="fi-social-twitter"></i></span>
            <span class="username">kubem</span>
          </a>
        </li>
        <li>
          <a href="https://www.linkedin.com/in/kubamarchwicki">
            <span class="icon foundation-icon"><i class="fi-social-linkedin"></i></span>
            <span class="username">kubamarchwicki</span>
          </a>
        </li>
      </ul>
    </div>

  </div>

</footer>


    <script src="/js/vendor/jquery.js"></script>
    <script src="/js/foundation.min.js"></script>
    <script>
      $(document).foundation();
    </script>
    <script src="/js/vendor/jquery.js"></script>
    <script src="/js/foundation/foundation.js"></script>
    <script>
      $(document).foundation();
      var doc = document.documentElement;
      doc.setAttribute('data-useragent', navigator.userAgent);
    </script>

    </body>
</html>