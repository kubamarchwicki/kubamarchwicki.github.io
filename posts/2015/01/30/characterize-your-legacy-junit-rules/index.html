<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Characterize your legacy with junit : Notepack</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="A randomized pack of notes">
    <link rel="canonical" href="http://jakub.marchwicki.pl/posts/2015/01/30/characterize-your-legacy-junit-rules/">
    <link href="http://jakub.marchwicki.pl/feed.xml" rel="alternate" type="application/atom+xml" title="Notepack" />

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/foundation.css"/>
    <link rel="stylesheet" href="/css/coderay.css"/>
    <link rel="stylesheet" href="/css/asciidoctor.css"/>
    <script src="/js/vendor/modernizr.js"></script>    
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/foundicons/3.0.0/foundation-icons.min.css">

        
    <!-- google analytics async -->
    <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-439480-4']);
    _gaq.push(['_trackPageview']);
    (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
    </script>
    

</head>


    <body>

    <header class="site-header">

  <div class="wrap">

    <a class="site-title" href="/"><i class="fi-folder"></i>Notepack</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
           viewBox="0 0 18 15" enable-background="new 0 0 18 15" xml:space="preserve">
          <path fill="#505050" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0
            h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#505050" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484
            h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#505050" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0
            c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>
      <div class="trigger">      
        
          <a class="page-link" href="/posts/">All posts</a>
        
          <a class="page-link" href="/speaking/">All speaking</a>
        
          <a class="page-link" href="/consultancy/">Consultancy</a>
        
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrap">
      <div class="post">

  <header class="post-header">
    <h1>Characterize your legacy with junit</h1>
    <p class="meta">Jan 30, 2015</p>
  </header>

  <article class="post-content">
  <div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>This is a blog post with is a longer read to my <a href="http://2015.tdd.geecon.org/">GeeCON TDD 2015</a> lightning talk presentation: <a href="/speaking/2015/01/30/geecon-tdd/">Characterize your legacy with jUnit Rules</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="what-are-characterization-tests-and-why-cared">What are characterization tests and why cared?</h2>
<div class="sectionbody">
<div class="paragraph">
<div class="title">Context</div>
<p>I&#8217;ve recently was involved in a project of upgrading our internal, vendor provided, not supported anymore HR application.
As we&#8217;ve been refactoring one of our internal systems (upgrade from Rails 1.8 to 3.0) - it impacted a few systems nearby. Mostly due to the way Rails handled SOAP web services, which were the basis of the integration; the WSDL needed changing significantly and thus needed the HR system client classes.</p>
</div>
<div class="paragraph">
<p>The whole idea was to replace existing axis stubs with new classes, keeping the interfaces backwards compatible. Rather simple task but not in this context: the app appeared to be a Java JSP web application with literally 10 class files and hundreds of JSP files with tons of logic in it (500+ lines per each JSP was a standard). A Java application in a bad PHP style.</p>
</div>
<div class="paragraph">
<p>What is more, this was type of integration where the order of parameters in the SOAP call were important; imagine how brittle and fragile that was.</p>
</div>
<div class="paragraph">
<p>While that looked fairly simple on paper (or diagram) the reality was much harder.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="data:image/png:base64," alt="A context diagram" width="690" height="294">
</div>
</div>
<div class="paragraph">
<div class="title">How to proceed</div>
<p>From the application logs (around 150MB per week, as nobody though of turning of global DEBUG in log4j.properties) I could be able to figure out what classes were responsible for the web service communication - that was the starting point.</p>
</div>
<div class="paragraph">
<p>The plan was to adhere to keep it working principle:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>extract the classes into a single jar</p>
</li>
<li>
<p>replace the classes with a lib</p>
</li>
<li>
<p>replace the lib with a new stub and client</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Few simple tasks to do. But what bothered me was how to make sure that the data structures before and after the changes are still the same.</p>
</div>
<div class="paragraph">
<div class="title">Actual tests</div>
<p>This is when I was started with characterization tests (the golden master). I needed to describe the existing application and after each step, test the changes against the model (my benchmark). Hence, the flow looked pretty much like this:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>analyze the class / method in subject, gain the conceptual understanding</p>
</li>
<li>
<p>invoke the method within tests</p>
</li>
<li>
<p>log complete output / compare the output with existing log output</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>When the tests went green - I felt much safer. I know this is far from ideal testing method, but at least it has given a little of confidence in the baby steps I was making.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="where-to-start">Where to start</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Ok, that was theory. Question is how to actually implement such test; recordings and assertions. The whole thing is actually pretty damn easy, especially with the last releases of JUnit. We will be leveraging Rule (ClassRule annotation to be precise) and the whole concept of TestRules.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="not-the-real-example">Not the real example</h2>
<div class="sectionbody">
<div class="paragraph">
<p>I&#8217;ll not drive through the actual code, as it was damn bad and will just make the point harder to understand. To give you a clue, here is a sample of the real production code (that was how the webservice was actually code - straight from the JSP file!)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="jsp">&lt;%-- MAIN FRAME --%&gt;

&lt;div style='width:100%; height:344px; display: block' id=&quot;mainmenu_ifr&quot;&gt;
&lt;table border='0' cellspacing='0' cellpadding='0' width='100%' style=&quot;margin-top:15px;&quot;&gt;
&lt;tr&gt;
&lt;td valign='top' width=&quot;200&quot; align=&quot;center&quot;&gt;

&lt;%
String prac_pnr =(String)session.getAttribute(&quot;prac_pnr&quot;);
if (prac_pnr ==null) prac_pnr =&quot;&quot;;


YdpPssClient client = new YdpPssClient();
String key=&quot;&quot;;
String logaid=prac_pnr;
String mode=&quot;small&quot;;
LAOSL1.setPP_LANG(langs[lang]);
LAOSL1.setPP_NSP(user_nsp);
LAOSL1.setPP_NRZK(user_nrzk);
LAOSL1.setPP_PNR(loga_pnr);
Manager.refresh(LAOSL1,(String)session.getAttribute(&quot;AdeliaKeyPoolName&quot;));
%&gt;

&lt;%@ page import=&quot;org.apache.axis.encoding.Base64&quot; %&gt;
&lt;%
String encoded = Base64.encode(client.getUserFotoFromWServices(key,logaid,mode));
%&gt;

&lt;% if(encoded!= null) { %&gt;
  &lt;IMG src=&quot;data:image/png;base64,&lt;%=encoded%&gt;&quot; border=&quot;0&quot; id=&quot;test&quot;&gt;
&lt;% }else{ %&gt;
  &lt;IMG height=&quot;177&quot; src=&quot;pics/noImage.jpg&quot; border=&quot;0&quot; id=&quot;test&quot;&gt;
&lt;% } %&gt;
&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>To skip such convoluted code I&#8217;ll use a more simple (simplistic) example- our legacy method is doing just string split and return the frist token.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">BusinessClass</span> {

  <span class="directive">public</span> <span class="predefined-type">String</span> businessMethod(<span class="predefined-type">String</span> param) {
    <span class="keyword">return</span> param.split(<span class="string"><span class="delimiter">&quot;</span><span class="content"> </span><span class="delimiter">&quot;</span></span>)[<span class="integer">0</span>];
  }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>And the test we will be using (actually in this case it&#8217;s more like a runner than the fully blown test).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">BusinessClassTest</span> {

  <span class="annotation">@ClassRule</span>
  <span class="directive">public</span> <span class="directive">static</span> CharacterizationRule rule =
      aRuleFor(BusinessClassTest.class)
      .build();

  <span class="directive">private</span> BusinessClass service = <span class="keyword">new</span> BusinessClass();

  <span class="annotation">@Test</span>
  <span class="directive">public</span> <span class="type">void</span> just_run_the_method() {
    <span class="directive">final</span> <span class="predefined-type">String</span> param = <span class="string"><span class="delimiter">&quot;</span><span class="content">first parameter</span><span class="delimiter">&quot;</span></span>
    <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">param = </span><span class="delimiter">&quot;</span></span> + param);
    <span class="predefined-type">String</span> output = service.businessMethod(param);
    <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">after split = </span><span class="delimiter">&quot;</span></span> + output);
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you probably noticed, there are no assertions in the test. That&#8217;s is deliberate - we are not asserting, because we probably don&#8217;t have a clue what should be the desired outcome. What we do, is logging some output without drilling into the details.</p>
</div>
<div class="paragraph">
<p>The whole idea is to log as much as possible and use the log as the feedback is the behaviour of the class (output) is not changing. This is what Michael Feathers described as characterization test.</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>A characterization test is a mean to describe (characterize) the actual behavior of an existing piece of software.</p>
</div>
</blockquote>
<div class="attribution">
&#8212; Michael Feathers<br>
<cite>Working Effectively with Legacy Code</cite>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="the-working-example">The working example</h2>
<div class="sectionbody">
<div class="paragraph">
<p>So, we see we need two modes for our tests: logging and verification. We should have exacly the same test code which can be run in two modes; collect all possible output and verify if the output is still the same. My approach would be to use an environment variable (flag) and pass it over during test invocation.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">final</span> <span class="directive">public</span> <span class="directive">static</span> <span class="predefined-type">String</span> ENV_NAME_FOR_RECORDING = <span class="string"><span class="delimiter">&quot;</span><span class="content">pinchpoint</span><span class="delimiter">&quot;</span></span>;

<span class="directive">private</span> <span class="type">boolean</span> isRecording() {
  <span class="predefined-type">String</span> env = <span class="predefined-type">System</span>.getProperty(ENV_NAME_FOR_RECORDING);
  <span class="keyword">return</span> (env != <span class="predefined-constant">null</span>);
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">mvn test -Dpinchpoint=true -Dtest=BusinessCodeTest</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">The logging part</div>
<p>I&#8217;ve written at the beginning we will be using junit rules to get the stuff done. Since version 4.7 jUnit provides rules, which are smarter runners - that can perform additional actions during test (think of aspects or interceptor). <code>External Resource</code> is one of such classes</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>A base class for Rules that set up an external resource before a test and tear it down afterward.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>The actual logging, that save the complete output to a default temp folder, to a file named after the class undergoing the test, logging might look like so.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">FileOutputCapture</span> <span class="directive">extends</span> ExternalResource {

  <span class="directive">protected</span> <span class="type">void</span> before() <span class="directive">throws</span> <span class="predefined-type">Throwable</span> {
    original = <span class="predefined-type">System</span>.out;
    <span class="predefined-type">PrintStream</span> pos = <span class="keyword">new</span> <span class="predefined-type">PrintStream</span>(capturedStream);
    <span class="predefined-type">System</span>.setOut(pos); <b class="conum">(1)</b>
  }

  <span class="directive">protected</span> <span class="type">void</span> after() {
    <span class="predefined-type">System</span>.setOut(original);    <b class="conum">(2)</b>
    <span class="keyword">try</span> {
      Files.write(outputFile.toPath(),
      capturedStream.toByteArray(),
      StandardOpenOption.APPEND);   <b class="conum">(3)</b>
    } <span class="keyword">catch</span> (<span class="exception">IOException</span> e) {
      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="exception">RuntimeException</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">File write failed! </span><span class="delimiter">&quot;</span></span>, e);
    }
  }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Sustitute the standard <code>System.out</code> with a stream to capturing all output</p>
</li>
<li>
<p>Restore the original <code>PrintStream</code></p>
</li>
<li>
<p>Write everything to file</p>
</li>
</ol>
</div>
<div class="paragraph">
<div class="title">The verification part</div>
<p>Now that we are good with the log, we can start refactoring the <code>BusinessClass</code> and do the verification if the output has changed in any way. Obviously, we would need another capture, without saving to a file.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">StreamOutputCapture</span> <span class="directive">extends</span> ExternalResource {
  <span class="predefined-type">PrintStream</span> original;

  <span class="directive">protected</span> <span class="type">void</span> before() <span class="directive">throws</span> <span class="predefined-type">Throwable</span> {
    original = <span class="predefined-type">System</span>.out;
    <span class="predefined-type">PrintStream</span> pos = <span class="keyword">new</span> <span class="predefined-type">PrintStream</span>(capturedStream);
    <span class="predefined-type">System</span>.setOut(pos);
  }

  <span class="directive">protected</span> <span class="type">void</span> after() {
    <span class="predefined-type">System</span>.setOut(original);
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Next thing is verification. Again, we will use jUnit goodies, this time a <code>Verifier</code> class</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Verifier is a base class for Rules like ErrorCollector, which turns passing test methods into failing tests if a verification check is failed</p>
</div>
</blockquote>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">CaptureVerifier</span> <span class="directive">extends</span> Verifier {

  <span class="directive">protected</span> <span class="type">void</span> verify() <span class="directive">throws</span> <span class="predefined-type">Throwable</span> {
    <span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt; actual = ReadLines.fromStream(capturedStream);
    <span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt; original = ReadLines.fromFile(pinchFile);

    <span class="predefined-type">Patch</span>&lt;<span class="predefined-type">String</span>&gt; patch = DiffUtils.diff(original, actual);

    assertThat(patch, is(empty()));
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>And if something went wrong, we get a nice feedback.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="txt">java.lang.AssertionError:
File:
  &lt;/tmp/com.example.BusinessClassTest.txt&gt;
read with charset &lt;UTF-8&gt; does not have the expected content:
line: &lt;3&gt;, expected:&lt;something&gt; but was:&lt;something else&gt;
      at com.example.BusinessClassTest.should_create_master_output_file</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="instead-of-summary">Instead of summary</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The code snippets above is not the actual implementation. These are samples, to give a clue what&#8217;s happening in the code. If you find this useful or interesting in any way, take a look on the actual <a href="https://github.com/kubamarchwicki/junit-characterization">implementation on Github</a> or use it directly in your project.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
  <span class="tag">&lt;groupId&gt;</span>pl.marchwicki<span class="tag">&lt;/groupId&gt;</span>
  <span class="tag">&lt;artifactId&gt;</span>junit-characterization<span class="tag">&lt;/artifactId&gt;</span>
  <span class="tag">&lt;packaging&gt;</span>jar<span class="tag">&lt;/packaging&gt;</span>
  <span class="tag">&lt;version&gt;</span>0.3<span class="tag">&lt;/version&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>I&#8217;m keen on feedback (say on <a href="https://twitter.com/kubem">@kubem at twitter</a>) if you find it useful. For me, in my context, it worked and allow me to fairly safety replace the webservice connector (client) in the application I really didn&#8217;t want to touch. Maybe it will work for you as well.</p>
</div>
<div class="paragraph">
<p>Some other references to this technique (also known as the Golden Master):</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="http://blog.thecodewhisperer.com/2014/09/28/surviving-legacy-code-with-golden-master-and-sampling/" class="bare">http://blog.thecodewhisperer.com/2014/09/28/surviving-legacy-code-with-golden-master-and-sampling/</a></p>
</li>
<li>
<p><a href="http://blog.adrianbolboaca.ro/2014/05/golden-master/" class="bare">http://blog.adrianbolboaca.ro/2014/05/golden-master/</a></p>
</li>
</ul>
</div>
</div>
</div>
  </article>

  
	<div id="disqus_thread"></div>
	<script type="text/javascript">
	    /* * * CONFIGURATION VARIABLES * * */
	    var disqus_shortname = 'jakubblog';
	    

	    /* * * DON'T EDIT BELOW THIS LINE * * */
	    (function() {
	        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
	        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
	        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	    })();
	</script>
	<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>

  
</div>

<!-- http://david.elbe.me/jekyll/2015/06/20/how-to-link-to-next-and-previous-post-with-jekyll.html -->

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrap">

    <div class="column">
      <ul>
        
          
          <li><a href="/posts/">
            <span class="icon foundation-icon"><i class="fi-page-multiple"></i></span>
            <span class="username">All posts</span>
            </a>
          </li>
          
        
          
          <li><a href="/speaking/">
            <span class="icon foundation-icon"><i class="fi-microphone"></i></span>
            <span class="username">All speaking</span>
            </a>
          </li>
          
        
          
          <li><a href="/consultancy/">
            <span class="icon foundation-icon"><i class="fi-comments"></i></span>
            <span class="username">Consultancy</span>
            </a>
          </li>
          
        
        <li>
          <a href="https://github.com/kubamarchwicki">
            <span class="icon foundation-icon"><i class="fi-social-github"></i></span>
            <span class="username">kubamarchwicki</span>
          </a>
        </li>
        <li>
          <a href="https://twitter.com/kubem">
            <span class="icon foundation-icon"><i class="fi-social-twitter"></i></span>
            <span class="username">kubem</span>
          </a>
        </li>
        <li>
          <a href="https://www.linkedin.com/in/kubamarchwicki">
            <span class="icon foundation-icon"><i class="fi-social-linkedin"></i></span>
            <span class="username">kubamarchwicki</span>
          </a>
        </li>
      </ul>
    </div>

  </div>

</footer>


    <script src="/js/vendor/jquery.js"></script>
    <script src="/js/foundation.min.js"></script>
    <script>
      $(document).foundation();
    </script>
    <script src="/js/vendor/jquery.js"></script>
    <script src="/js/foundation/foundation.js"></script>
    <script>
      $(document).foundation();
      var doc = document.documentElement;
      doc.setAttribute('data-useragent', navigator.userAgent);
    </script>

    </body>
</html>