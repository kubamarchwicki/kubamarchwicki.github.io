<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>The art of testing an EJB application – Part II (mocking) : Notepack</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="A randomized pack of notes">
    <link rel="canonical" href="http://jakub.marchwicki.pl/posts/2011/05/06/the-art-of-testing-an-ejb-application-part-ii/">
    <link href="http://jakub.marchwicki.pl/feed.xml" rel="alternate" type="application/atom+xml" title="Notepack" />

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/foundation.css"/>
    <link rel="stylesheet" href="/css/coderay.css"/>
    <link rel="stylesheet" href="/css/asciidoctor.css"/>
    <script src="/js/vendor/modernizr.js"></script>    
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/foundicons/3.0.0/foundation-icons.min.css">

    

</head>


    <body>

    <header class="site-header">

  <div class="wrap">

    <a class="site-title" href="/"><i class="fi-folder"></i>Notepack</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
           viewBox="0 0 18 15" enable-background="new 0 0 18 15" xml:space="preserve">
          <path fill="#505050" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0
            h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#505050" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484
            h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#505050" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0
            c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>
      <div class="trigger">      
        
          <a class="page-link" href="/posts/">All posts</a>
        
          <a class="page-link" href="/speaking/">All speaking</a>
        
          <a class="page-link" href="/consultancy/">Consultancy</a>
        
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrap">
      <div class="post">

  <header class="post-header">
    <h1>The art of testing an EJB application – Part II (mocking)</h1>
    <p class="meta">May 6, 2011</p>
  </header>

  <article class="post-content">
  <div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p><a href="/posts/2011/05/02/the-art-of-testing-an-ejb-application-part-i/">The previous post on testing was more like an introduction</a> – now it’s time for some real testing. While I’ve only touched the surface with unit-unit tests, I think functional testing needs a deeper drilling. Here we go!</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="service-encapsulation">Service encapsulation</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Decoupling services (having one service dependent on others, that encapsulate bits and pieces of functionality) is a fairly good practices. This ties nicely with a dependency injection feature of an EJB container; beans get resolved, initiated – happy days. Surely, not only EJB container does it, but comparing CDI frameworks is not in scope of this post. It’s about focused integration testing so let me start with with a simple example – a business service utilizing the TrimService from the previous post. If we are trying to keep our tests quick and robust, we need to get into container’s shoes and perform dependency injection on our own – this is where the loosely coupling starts to be a little bit painful.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Stateless</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">BusinessService</span> <span class="directive">implements</span> BusinessServiceLocal {
          <span class="annotation">@EJB</span> TrimServiceLocal trimService;
    <span class="directive">public</span> BusinessMethodResponse businessMethod(TransferObject obj) {
      <span class="comment">//some logic</span>
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this particular example the container does a fairly simple and straightforward job. Instantiating of this service is nothing extraordinary and there is nothing that should stop us doing the same during in tests.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">BusinessServiceTest</span> {

  BusinessService businessService;

  <span class="annotation">@BeforeClass</span>
  <span class="directive">public</span> <span class="type">void</span> setup() {
    businessService = <span class="keyword">new</span> BusinessService();
    businessService.trimService = <span class="keyword">new</span> TrimService();
  }

  <span class="annotation">@Test</span>
  <span class="directive">public</span> <span class="type">void</span> successfulBusinessMethodForSpecificCase() {
    TransferObject obj = <span class="keyword">new</span> TransferObject();
    <span class="comment">//populate the object</span>

    BusinessMethodResponse response = businessService.businessMethod(obj);
    Assert.assertNotNull(response);
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Please note that the trimService field does not have an explicit visibility defined, which make the field of package scope. If we keep tests in the same package as the service, we can fiddle with service’s fields without any reflection API magic.</p>
</div>
<div class="paragraph">
<p>Even though this can work quite smoothly, we are moving beyond unit testing (some might say some unit tests principles might be violated, because we check the behaviour of more than one class – TrimService is tested as well). I won’t be bothered about this; at some point it’s necessary to take a more holistic approach towards testing. That’s exactly what’s happening here: focused integration testing; a carefully curated set of features was chosen and tested in isolation. That way we can see how certain blocks of the application works in conjunction with other elements of the system. On the other hand, the tests are still kept relatively small and fast.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="mocking-services">Mocking services</h2>
<div class="sectionbody">
<div class="paragraph">
<p>When the services are getting more and more complex, a simple initialization might appear troublesome, producing too much boilerplate code. There are ways to do it faster – with mockups. From two most popular mocking frameworks: EasyMock (<a href="http://easymock.org/" class="bare">http://easymock.org/</a>) and Mockito (<a href="http://mockito.org/" class="bare">http://mockito.org/</a>), I pick the latter. A quick glimpse over Mockito website should give a decent clue how it works and how it follows given-when-then principle.</p>
</div>
<div class="paragraph">
<p>See an example – a configuration service which returns configuration codes from a database. A Hibernate named query is used to retrieve raw, persisted data and some additional stripping logic is applied. Given a following service,</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Stateless</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">ConfigService</span> <span class="directive">implements</span> ConfigServiceLocal {

  <span class="annotation">@EJB</span>
  CrudServiceLocal crudService;

  <span class="directive">public</span> <span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt; getConfigCodes(<span class="predefined-type">String</span> type) {
    <span class="predefined-type">List</span>&lt;FuncConfg&gt; funcConfgResults =
      crudService.findByNamedQuery(<span class="string"><span class="delimiter">&quot;</span><span class="content">FuncConfg.findByType</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">type</span><span class="delimiter">&quot;</span></span>, type);
    <span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt; configCodes = <span class="comment">//some additional processing</span>
    <span class="keyword">return</span> configCodes;
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>the process of mocking data and testing may look like this</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">ConfigServiceTest</span> {

  ConfigService configService;

  <span class="annotation">@BeforeClass</span>
  <span class="directive">public</span> <span class="type">void</span> setup() {
    configService = <span class="keyword">new</span> ConfigService();
    configService.crudService = Mockito.mock(CommonCrudService.class);
  }

  <span class="annotation">@Test</span>
  <span class="directive">public</span> <span class="type">void</span> defaultTypeConfig() {
    <span class="directive">final</span> <span class="predefined-type">String</span> deafultType = <span class="string"><span class="delimiter">&quot;</span><span class="content">defaultType</span><span class="delimiter">&quot;</span></span>;
    Mockito.when(configService.crudService
        .findByNamedQuery(<span class="string"><span class="delimiter">&quot;</span><span class="content">FuncConfg.findByType</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">type</span><span class="delimiter">&quot;</span></span>, defaultType))
        .thenReturn(defaultFuncConfgList());

    <span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt; confgCd = configService.getConfigCodes(defaultType);
    Assert.assertNotNull(confgCd);
    Assert.assertEquals(confgCd.size(), <span class="integer">10</span>);
    <span class="comment">//some additional assertions</span>
  }

  <span class="directive">private</span> <span class="predefined-type">List</span>&lt;FuncConfg&gt; defaultFuncConfgList() {
    <span class="comment">//creates default list of codes</span>
  }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="handling-database">Handling database</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Last, but not least – ‘talking’ to a database. This is getting us closer to an end-to-end integration testing – though the tests are still fairly robust, small and fast. In fact, what is happening here is pretty much the same what OpenEJB does when it bootstraps a database, but faster.</p>
</div>
<div class="paragraph">
<p>I use this approach in two scenarios: when I want to test named queries against real data and when a snapshot of a production / test database is available and can be loaded from file, instead of handcrafting and mocking each data object individually.</p>
</div>
<div class="paragraph">
<p>Let’s use the previous example of the configuration service. Mocking the crud service worked perfectly fine, but when the number of different test cases increases significantly, quite a lot of test code needs to be written. There are smarter ways to do it. In my projects I tend to use this DataSourceMockUp class which bootstraps hibernate and exposes the EntityManager.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">DataSourceMockUp</span> {

  <span class="directive">private</span> EntityManager entityManager;

  <span class="directive">public</span> DataSourceMockUp(Builder builder) {
    <span class="comment">//bootstrap hibernate</span>
    Ejb3Configuration config = <span class="keyword">new</span> Ejb3Configuration();
    config.setProperty(<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.dialect</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">org.hibernate.dialect.HSQLDialect</span><span class="delimiter">&quot;</span></span>)
        .setProperty(<span class="string"><span class="delimiter">&quot;</span><span class="content">javax.persistence.transactionType</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">RESOURCE_LOCAL</span><span class="delimiter">&quot;</span></span>)
        .setProperty(<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.connection.driver_class</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">org.hsqldb.jdbcDriver</span><span class="delimiter">&quot;</span></span>)
        .setProperty(<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.connection.url</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">jdbc:hsqldb:mem:testdb</span><span class="delimiter">&quot;</span></span>)
        .setProperty(<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.connection.username</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">sa</span><span class="delimiter">&quot;</span></span>)
        .setProperty(<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.connection.password</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>)
        .setProperty(<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.connection.pool_size</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">1</span><span class="delimiter">&quot;</span></span>)
        .setProperty(<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.connection.autocommit</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span>)
        .setProperty(<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.provider_class</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">org.hibernate.cache.HashtableCacheProvider</span><span class="delimiter">&quot;</span></span>)
        .setProperty(<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.hbm2ddl.auto</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">create</span><span class="delimiter">&quot;</span></span>)
        .setProperty(<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.show_sql</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span>);

    <span class="comment">//add entities</span>
    <span class="keyword">for</span> (<span class="predefined-type">Class</span>&lt;?&gt; clazz : builder.annotatedClass) {
      config.addAnnotatedClass(clazz);
    }

    <span class="comment">//set up services</span>
    <span class="comment">//even though the method is deprecated - this is one to be used</span>
    <span class="comment">//https://forum.hibernate.org/viewtopic.php?f=10&amp;t=966871</span>
    EntityManagerFactory entityManagerFactory = config.createEntityManagerFactory();
    setEntityManager(entityManagerFactory.createEntityManager());

    <span class="comment">//import initial data</span>
    EntityTransaction tx = getEntityManager().getTransaction();
    tx.begin();

    SchemaExport schemaExport = <span class="keyword">new</span> SchemaExport(config.getHibernateConfiguration());
    schemaExport.setImportFile(builder.importSqlFile);
    schemaExport.create(<span class="predefined-constant">true</span>, <span class="predefined-constant">true</span>);
    tx.commit();
  }

  <span class="directive">public</span> <span class="directive">static</span> <span class="type">class</span> <span class="class">Builder</span> {
    <span class="directive">private</span> <span class="predefined-type">String</span> importSqlFile;
    <span class="directive">private</span> <span class="predefined-type">List</span>&lt;<span class="predefined-type">Class</span>&lt;?&gt;&gt; annotatedClass = <span class="keyword">new</span> <span class="predefined-type">ArrayList</span>&lt;<span class="predefined-type">Class</span>&lt;?&gt;&gt;();

    <span class="directive">public</span> Builder fromSqlFile(<span class="predefined-type">String</span> importSqlFile) {
      <span class="local-variable">this</span>.importSqlFile = importSqlFile;
      <span class="keyword">return</span> <span class="local-variable">this</span>;
    }

    <span class="directive">public</span> Builder withAnnotatedClass(<span class="predefined-type">Class</span>&lt;?&gt; clazz) {
      <span class="local-variable">this</span>.annotatedClass.add(clazz);
      <span class="keyword">return</span> <span class="local-variable">this</span>;
    }

    <span class="directive">public</span> DataSourceMockUp build() {
      <span class="keyword">return</span> <span class="keyword">new</span> DataSourceMockUp(<span class="local-variable">this</span>);
    }
  }

  <span class="directive">public</span> <span class="type">void</span> setEntityManager(EntityManager entityManager) {
    <span class="local-variable">this</span>.entityManager = entityManager;
  }

  <span class="directive">public</span> EntityManager getEntityManager() {
    <span class="keyword">return</span> entityManager;
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>With a data source mocked, the test class looks like this</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">ConfigServiceTest</span> {
  ConfigService configService;

  <span class="annotation">@BeforeClass</span>
  <span class="directive">public</span> <span class="type">void</span> setup() {
    DataSourceMockUp mockup = <span class="keyword">new</span> DataSourceMockUp.Builder()
        .fromSqlFile(sqlLocation)
        .withAnnotatedClass(FuncConfg.class).build();

    CommonCrudService crudService = <span class="keyword">new</span> CommonCrudService();
    crudService.entityManager = mockup.getEntityManager();

    configService = <span class="keyword">new</span> ConfigService();
    configService.crudService = crudService;
  }

  <span class="annotation">@Test</span>
  <span class="directive">public</span> <span class="type">void</span> getConfigCodesForDefaultType() {
    <span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt; codes = configService.getConfigCodes(<span class="string"><span class="delimiter">&quot;</span><span class="content">T</span><span class="delimiter">&quot;</span></span>);
    Assert.assertNotNull(codes);
    <span class="comment">//... and so on</span>
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>One can argue that the same can be achieved with an OpenEJB. True, the whole container can be bootstrapped and all the services will be injected automatically (including the persistence context). However, as I’ve outlined in the first part of this series – the tests are categorised by the speed of execution and handcrafting hibernate with w pre-prepared SQL script is much faster that running the whole EJB container. What is more – it’s more hands on, errors are easier to spot and there is less magic going under the bonnet. As I am planning to show in the next post – things like error recovery, detailed configuration and so on are not 1, 2, 3 with OpenEJB. That’s why I find focused integration testing a compromise between simple unit testing and a holistic, end-to-end approach.</p>
</div>
</div>
</div>
  </article>

  
	<div id="disqus_thread"></div>
	<script type="text/javascript">
	    /* * * CONFIGURATION VARIABLES * * */
	    var disqus_shortname = 'jakubblog';
	    var disqus_url = 'http://www.marchwicki.pl/blog/2011/05/the-art-of-testing-an-ejb-application-part-ii/';

	    /* * * DON'T EDIT BELOW THIS LINE * * */
	    (function() {
	        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
	        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
	        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	    })();
	</script>
	<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>

  
</div>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrap">

    <div class="column">
      <ul>
        
          
          <li><a href="/posts/">
            <span class="icon foundation-icon"><i class="fi-page-multiple"></i></span>
            <span class="username">All posts</span>
            </a>
          </li>
          
        
          
          <li><a href="/speaking/">
            <span class="icon foundation-icon"><i class="fi-microphone"></i></span>
            <span class="username">All speaking</span>
            </a>
          </li>
          
        
          
          <li><a href="/consultancy/">
            <span class="icon foundation-icon"><i class="fi-comments"></i></span>
            <span class="username">Consultancy</span>
            </a>
          </li>
          
        
        <li>
          <a href="https://github.com/kubamarchwicki">
            <span class="icon foundation-icon"><i class="fi-social-github"></i></span>
            <span class="username">kubamarchwicki</span>
          </a>
        </li>
        <li>
          <a href="https://twitter.com/kubem">
            <span class="icon foundation-icon"><i class="fi-social-twitter"></i></span>
            <span class="username">kubem</span>
          </a>
        </li>
        <li>
          <a href="https://www.linkedin.com/in/kubamarchwicki">
            <span class="icon foundation-icon"><i class="fi-social-linkedin"></i></span>
            <span class="username">kubamarchwicki</span>
          </a>
        </li>
      </ul>
    </div>

  </div>

</footer>


    <script src="/js/vendor/jquery.js"></script>
    <script src="/js/foundation.min.js"></script>
    <script>
      $(document).foundation();
    </script>
    <script src="/js/vendor/jquery.js"></script>
    <script src="/js/foundation/foundation.js"></script>
    <script>
      $(document).foundation();
      var doc = document.documentElement;
      doc.setAttribute('data-useragent', navigator.userAgent);
    </script>

    </body>
</html>