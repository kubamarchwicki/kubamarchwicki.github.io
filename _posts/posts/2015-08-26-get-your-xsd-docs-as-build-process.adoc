---
layout: post
categories: posts
title: Get your XSD documentation as a part of build process
excerpt: Say what you want about XML and XSD - still the tooling for building your contract first models in XML is most mature. Still reading through the XSD is tedious. Still generating HTML preview doesn't really work. But on the other hand, what if you try to get this as code. 
---


I've started this as a http://stackoverflow.com/questions/32106133/xsd-documentation-as-a-part-of-build-process[stackoverflow question]:

[quote]
____

I've got multiple XSD files describing a schema. I'd like to generate a human readable documentation as a result of a build process.

The XSD is maintained and review within repository (gitflow) and committing the documentation makes the repository cluttered. I'd like to generate human readable HTML during the build process (maven / gradle / ant build or simple CLI interface)

Found this post How to convert XSD to human readable documentation? and DocFlex/XML Maven plugin seems interesting but I can't believe that's the only one.

Any helpful tips on that?
____

This pretty much outlines the idea: treat XSD as code, get that into repository and have all the subsidiary artifacts elements generated as a part of the build process (not to have autogenerated HTML files in the repository). 

This can be pretty easy achievable with OxygenXML Editor's _schemaDocumentation.sh_ script, however it requires OxygenXML installed on your build environment, which is something I'd tend to avoid (I generally avoid having build dependent on the environment beyond just JVM; if build needs something I want it to download it for itself).
	
== Tools

I was using OxygenXML Editor on my desktop and I like the documentation is generated (the HTML). I also liked a flow that the document is reviewed through the visual part (html) but the comments and remarks are done in the source (code) in a typical code review process. I started to look for tools that could supported this kind of workflow. 

OxygenXML Editor _schemaDocumentation.sh_ script to certain extent could support this flow, but some additional changes were needed to the bash scripts. So I started to look in some different places. 

== DocFlex

http://www.filigris.com/docflex-xml/maven.php[DocFlex/XML Maven Integration] looks pretty promising. Installation went smoothly getting some output generated was pretty straightforward - as presented in http://www.filigris.com/docflex-xml/maven.php#plugin.example1[examples] 

However, only after some more detailed reading I realized that images are only supported through integration with 3rd party tools like XMLSpy or OxygenXML. 

If all you need is just HTML view (pretty comprehensive after all - but without images) DocFlex is probably enough. It's not very expensive (200$ for license) - but to be honest I haven't been looking for any free alternatives. Lack of pictures was a deal breaker for me. 

== Oxygen wrapped in Gradle sauce

Getting back to the OxygenXML, it's a program written in Java and the _schemaDocumentation.sh_ script is actually invoking a headless application with some command line arguments. If so, I can invoke it directly from a build script. I used Gradle for that 

[source, groovy]
----
apply plugin: 'java'

version = "1.0-SNAPSHOT"

ext {
  generatedDir = new File(buildDir, "generated-html")
}

def OXYGEN_HOME = "/opt/java/oxygen"	//<1>
def schemaFiles = ["page", "metadata"]	//<2>

schemaFiles.each { pageName -> 
  task "${pageName}SchemaTask"(type: JavaExec) {
    mkdir generatedDir

    classpath = files([
      "$OXYGEN_HOME", 
      "$OXYGEN_HOME/classes", 
      "$OXYGEN_HOME/lib", 
      "$OXYGEN_HOME/lib/oxygen.jar", 
      "$OXYGEN_HOME/lib/oxygenDeveloper.jar", 
      "$OXYGEN_HOME/lib/fop.jar", 
      "$OXYGEN_HOME/lib/xmlgraphics-commons-1.5.jar", 
      "$OXYGEN_HOME/lib/batik-all-1.7.jar", 
      "$OXYGEN_HOME/lib/xercesImpl.jar", 
      "$OXYGEN_HOME/lib/xml-apis.jar", 
      "$OXYGEN_HOME/lib/org.eclipse.wst.xml.xpath2.processor_1.2.0.jar", 
      "$OXYGEN_HOME/lib/icu4j.jar", 
      "$OXYGEN_HOME/lib/saxon.jar", 
      "$OXYGEN_HOME/lib/saxon9ee.jar", 
      "$OXYGEN_HOME/lib/log4j.jar", 
      "$OXYGEN_HOME/lib/resolver.jar", 
      "$OXYGEN_HOME/lib/oxygen-emf.jar", 
      "$OXYGEN_HOME/lib/commons-httpclient-3.1.jar", 
      "$OXYGEN_HOME/lib/commons-codec-1.3.jar", 
      "$OXYGEN_HOME/lib/commons-logging-1.0.4.jar", 
      "$OXYGEN_HOME/lib/httpcore-4.3.2.jar", 
      "$OXYGEN_HOME/lib/httpclient-cache-4.3.5.jar", 
      "$OXYGEN_HOME/lib/httpclient-4.3.5.jar", 
      "$OXYGEN_HOME/lib/fluent-hc-4.3.5.jar", 
      "$OXYGEN_HOME/lib/httpmime-4.3.5.jar", 
      "$OXYGEN_HOME/lib/commons-logging-1.1.3.jar", 
      "$OXYGEN_HOME/lib/commons-codec-1.6.jar"
    ].toList())
    
    main = 'ro.sync.xsd.documentation.XSDSchemaDocumentationGenerator'	
    jvmArgs = ["-Djava.awt.headless=true"]
    args = ["schema/${pageName}.xsd", 
    	"-format:html", 
    	"-split:location", 
    	"-out:$generatedDir/${pageName}.html"]	
  }	
}

task schema(dependsOn: tasks.matching { Task task -> 
	task.name.endsWith("SchemaTask")}) {
}

defaultTasks 'schema'
----
<1> External path to OxygenXML
<2> HTML is generated for every file defined in this list

So far Gradle looks like an overkill but this is still work in progress. With the power of Gradle we can try to get rid of all external dependencies and make this build self-sufficient. 

== OxygenXML based schema documentator

Full Oxygen package is 150MB and comes with all different things (not really needed for HTML schema generation). However, what is only needed here is a _schemaDocutation.sh_ which we can run independently. So with this little script fellow we can try to strip down Oxygen to the only part required

[source, bash]
----
mkdir -p oxygen-lite/lib

for f in `cat $OXYGEN_HOME/schemaDocumentation.sh | grep CP= | tr ":" "\n" | cut -d "/" -f3 | grep jar`
do
	file="$OXYGEN_HOME/lib/$f"
	if [ -e $file ] 
	then
		cp $file oxygen-lite/lib/$f
	fi
done

cp $OXYGEN_HOME/licensekey.txt oxygen-lite
----

Next step would be to combine the build with the stripped down ('lite') version of Oxygen. I used https://github.com/ysb33r/groovy-vfs[Groovy VFS] DSL library to be able to process external downloads and unzip my _Oxygen-lite_

[source, groovy]
----
buildscript {
  repositories {
    jcenter()
  }
  dependencies {
    classpath 'org.ysb33r.gradle:vfs-gradle-plugin:1.0-beta1'
    classpath 'commons-httpclient:commons-httpclient:3.1'
  }
}

apply plugin: 'org.ysb33r.vfs'
apply plugin: 'java'

version = "1.0-SNAPSHOT"

ext {
  downloadDir = new File(buildDir, "download")
  generatedDir = new File(buildDir, "generated-html")
}

task download << {
  mkdir downloadDir
  vfs {
    cp "zip:https://your-host/path-to-oxygen/oxygen-lite.zip",
    downloadDir, recursive:true, overwrite:true
  }
}

download {
  description "Downloading oxygen"
  outputs.dir downloadDir
}

def OXYGEN_HOME = "$downloadDir/oxygen-lite"
def schemaFiles = ["page", "metadata"]

apply plugin: 'java'

version = "1.0-SNAPSHOT"

ext {
  generatedDir = new File(buildDir, "generated-html")
}

def OXYGEN_HOME = "/opt/java/oxygen"	//<1>
def schemaFiles = ["page", "metadata"]	//<2>

schemaFiles.each { pageName -> 
  task "${pageName}SchemaTask"(type: JavaExec) {
    mkdir generatedDir

    classpath = files([
      "$OXYGEN_HOME", 
      "$OXYGEN_HOME/classes", 
      "$OXYGEN_HOME/lib", 
      "$OXYGEN_HOME/lib/oxygen.jar", 
      "$OXYGEN_HOME/lib/oxygenDeveloper.jar", 
      "$OXYGEN_HOME/lib/fop.jar", 
      "$OXYGEN_HOME/lib/xmlgraphics-commons-1.5.jar", 
      "$OXYGEN_HOME/lib/batik-all-1.7.jar", 
      "$OXYGEN_HOME/lib/xercesImpl.jar", 
      "$OXYGEN_HOME/lib/xml-apis.jar", 
      "$OXYGEN_HOME/lib/org.eclipse.wst.xml.xpath2.processor_1.2.0.jar", 
      "$OXYGEN_HOME/lib/icu4j.jar", 
      "$OXYGEN_HOME/lib/saxon.jar", 
      "$OXYGEN_HOME/lib/saxon9ee.jar", 
      "$OXYGEN_HOME/lib/log4j.jar", 
      "$OXYGEN_HOME/lib/resolver.jar", 
      "$OXYGEN_HOME/lib/oxygen-emf.jar", 
      "$OXYGEN_HOME/lib/commons-httpclient-3.1.jar", 
      "$OXYGEN_HOME/lib/commons-codec-1.3.jar", 
      "$OXYGEN_HOME/lib/commons-logging-1.0.4.jar", 
      "$OXYGEN_HOME/lib/httpcore-4.3.2.jar", 
      "$OXYGEN_HOME/lib/httpclient-cache-4.3.5.jar", 
      "$OXYGEN_HOME/lib/httpclient-4.3.5.jar", 
      "$OXYGEN_HOME/lib/fluent-hc-4.3.5.jar", 
      "$OXYGEN_HOME/lib/httpmime-4.3.5.jar", 
      "$OXYGEN_HOME/lib/commons-logging-1.1.3.jar", 
      "$OXYGEN_HOME/lib/commons-codec-1.6.jar"
    ].toList())
    
    main = 'ro.sync.xsd.documentation.XSDSchemaDocumentationGenerator'	
    jvmArgs = ["-Djava.awt.headless=true"]
    args = ["schema/${pageName}.xsd", 
    	"-format:html", 
    	"-split:location", 
    	"-out:$generatedDir/${pageName}.html"]	
  }	
}

task schema(dependsOn: ['download', 
	tasks.matching { Task task -> task.name.endsWith("SchemaTask")}]) {

}

defaultTasks 'schema'
----

== Setting up the CI

The above script sits together with XSD schema files in the repository. Whenever a new version of XSD is issued (or a new work is initiated in a 'feature branch') our Jenkins picks up the changes and rebuild the docs. That way the schema can be viewed in a human readable name while the comments can be attached to the actual XSDs in the repository. This kind of works for us. 

I'm still not sure if Oxygen is the best tool for the job, but I couldn't find a better one (not that I was looking for it very hard). So if you have  suggestions how to proceed differently - I welcome them in comments. 
